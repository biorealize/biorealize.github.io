<!DOCTYPE HTML>
<html>
    <head>
    <title>Biorealize: Node</title>

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />


    <link rel="stylesheet" href="stylesheets/html5reset.css" media="all">
    <link rel="stylesheet" href="stylesheets/style.css" />
    <link rel="stylesheet" href="stylesheets/col.css" media="all">
    <link rel="stylesheet" href="stylesheets/4cols.css" media="all"/>
    <link rel="stylesheet" href="stylesheets/2cols.css" media="all"/>

    <!-- Responsive and mobile friendly -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-1.11.0.min.js" type="text/javascript" ></script>
    <!-- SVG lib -->    
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.5.0/svg.js" type="text/javascript"></script>

    <script type="text/javascript" src="javascripts/snap.svg.js"></script>

    <!-- Functions -->    
    <script type="text/javascript" src="javascripts/functions.js"></script>

    <!-- CanvasJS -->
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

    <!-- This is the MQTT related section -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

    <!-- SVG Graphics -->    
   <script type="text/javascript" src="javascripts/graphics.js"></script>   
    
    <script type="text/javascript">

  // Create a client instance
  // m10.cloudmqtt.com

  //var client = new Paho.MQTT.Client("m11.cloudmqtt.com", 39547, "web_" + parseInt(Math.random() * 100, 10));//

  //client = new Paho.MQTT.Client("m10.cloudmqtt.com", 37282, "web_" + parseInt(Math.random() * 100, 10));


  // set callback handlers
  /*
  client.onConnectionLost = onConnectionLost;
  client.onMessageArrived = onMessageArrived;

  var options = {
    useSSL: true,
    //userName: "buwynvxd",
    userName: "bpbgifio",
    password: "TaxZFQ5IkTjE",
    //password: "AhFmFn2ibFAS",
    onSuccess:onConnect,
    onFailure:doFail
  }
  */

  // connect the client
  //client.connect(options);

  // called when the client connects


  function onConnect() {
    // Once a connection has been made, make a subscription and send a message.
    console.log("onConnect");
    client.subscribe("/#");       
    message = new Paho.MQTT.Message("Hello CloudMQTT"); //InteractiveCommand.Agitate(1)
    message.destinationName = "/MDS/Interactive";
    client.send(message); 
  }

  function doFail(e){
    console.log(e);
  }

  // called when the client loses its connection
  function onConnectionLost(responseObject) {
    if (responseObject.errorCode !== 0) {
      console.log("onConnectionLost:"+responseObject.errorMessage);

    }
  }


  function onMessageArrived(message){
    
    console.log("onMessageArrived: " + message.payloadString);


    //Update the status of the interface
    document.getElementById("machineStatusBox").innerHTML = 'Node Ready' ;  
    toggleMenuElement("serverSettingsDisplayBox");

    //parse the incoming message

    //this tells us if the machine came from teensy(@NOUT) or the spec(@spec)
    var msgSource = message.payloadString.split(':')[0];
    var msgContent = message.payloadString.split(':')[1];
    
    //if the message is from teensy, look for a '*'
    if (msgSource == '@NOUT'){

        var msgType = msgContent.split('*')[0];

        if (msgType == 'SYRINGE_ID'){
            var syrinegID = msgContent.split('*')[1]
            document.getElementById("machineStatusBox").innerHTML = 'Experiment ID: ' + syrinegID + 'received' ; 
        }
        else if (msgType == 'TEMP'){
            var currentTemp = msgContent.split('*')[1]
            document.getElementById("machineStatusBox").innerHTML = 'Current Temperature is: ' + currentTemp ; 
        }
    }

    else if (msgSource =='@spec'){
    
                    var line = "";  // or uncomment this to overwrite the existing message
                    // parse the incoming message as a JSON object
                    
                    
                    //var data = msg.data;
                    var data = message.payloadString.substr(6);
                    //console.log(data) ; 
                    // dispatch to appropriate, if indicated
                    // messages that require special handling are JSON statements that have an "=" in them
                    // the left of the '=' is the name of the handler function, 
                    // and the right of the '=' is a JSON statement that has the on which the handler will act
                    var eqAt = data.search('=');

                    if (eqAt > 0){
                        // Get the var name
                        // for example, a message like "TEST={x:1,y:2,z:3"} will yield a var named "TEST"
                        var varName = data.substr(0,eqAt);
                        
                        // convert the JSON into a local value
                        // whose name matches varName
                        var functionArg = eval(data);
                        
                        // build up a statement that will invoke the handler function,
                        // passing the structure as an argument
                        // for example, a message like "TEST={x:1,y:2,z:3"} 
                        // will cause evalExpression to have the value 'handle_TEST_response(TEST)'
                        // which, when evaluated, will pass the TEST object to the handle_TEST function
                        var evalExpression = "handle_" + varName + "_response(" + varName + ")" 
                        eval(evalExpression);
                        
                    }
                    else{
                        console.log(data);
                        // build the output from the topic and payload parts of the object
                        //line += "<p>"+data+"</p>";
                        // replace the messages div with the new "line"
                        //document.getElementById('messages').innerHTML = line;
                        //ws.send(JSON.stringify({data:data}));
                    }


    }


    //if (receivedTopic =='@NOUT:SYRINGE_ID'){
    //    var syrinegID = receivedTopic = message.payloadString.split('*')[1]
    //    document.getElementById("machineStatusBox").innerHTML = 'Experiment ID: ' + syrinegID + 'received' ; 
    //}

  }//end of onMessageArrived function


  // called when a message arrives -- Old version
  /*
  function onMessageArrived2(message) {

    //console.log("onMessageArrived: "+ message.payloadString);

    console.log("onMessageArrived");

    var receivedTopic = message.payloadString.split(':')[0];
    //document.getElementById("status").innerHTML = 'Microbial Design Studio Ready' ;
    document.getElementById("machineStatusBox").innerHTML = 'Node Ready' ;  

    //toggleMenuElement("experimentReadyElements");
    //document.getElementById("experimentReadyElements").style.display = "block";// for some reason, the toggle function didn't work on this.
    toggleMenuElement("serverSettingsDisplayBox");
    

    //if ( !machineDriveEnabled && receivedTopic =='Echo'){

    if ( !machineDriveEnabled && receivedTopic =='@IncubatorWheel'){
        angle = message.payloadString.split('=')[1];
        console.log(angle);
        animateWheel(angle * -180/Math.PI, 50);//250
    }
//@heater:temp_sp= 37.0;
    else if ( receivedTopic =='@heater'){
        temp_sp = message.payloadString.split('=')[1];
        temp_sp  = temp_sp .substring(0, temp_sp.length - 1); //eliminating the trailing ";"
        console.log(temp_sp);
        displayTemperature(temp_sp);
    }

    else if (receivedTopic=='@spec'){
    
                    var line = "";  // or uncomment this to overwrite the existing message
                    // parse the incoming message as a JSON object
                    
                    
                    //var data = msg.data;
                    var data = message.payloadString.substr(6);
                    //console.log(data) ; 
                    // dispatch to appropriate, if indicated
                    // messages that require special handling are JSON statements that have an "=" in them
                    // the left of the '=' is the name of the handler function, 
                    // and the right of the '=' is a JSON statement that has the on which the handler will act
                    var eqAt = data.search('=');

                    if (eqAt > 0){
                        // Get the var name
                        // for example, a message like "TEST={x:1,y:2,z:3"} will yield a var named "TEST"
                        var varName = data.substr(0,eqAt);
                        
                        // convert the JSON into a local value
                        // whose name matches varName
                        var functionArg = eval(data);
                        
                        // build up a statement that will invoke the handler function,
                        // passing the structure as an argument
                        // for example, a message like "TEST={x:1,y:2,z:3"} 
                        // will cause evalExpression to have the value 'handle_TEST_response(TEST)'
                        // which, when evaluated, will pass the TEST object to the handle_TEST function
                        var evalExpression = "handle_" + varName + "_response(" + varName + ")" 
                        eval(evalExpression);
                        
                    }
                    else{
                        console.log(data);
                        // build the output from the topic and payload parts of the object
                        //line += "<p>"+data+"</p>";
                        // replace the messages div with the new "line"
                        //document.getElementById('messages').innerHTML = line;
                        //ws.send(JSON.stringify({data:data}));
                    }


    }

    //document.getElementById("status").innerHTML = receivedMessage ; 

    //document.getElementById("status").innerHTML =  "<span style=\"color:#355ea3\">" + message.payloadString + "</span>";; 


  }
*/
    /*  
    function sendMachineMessage(m) {
        if (client) { 
            var topic = m.split(":")[0].substr(1); // get the @ prefix as a topic
            var message = new Paho.MQTT.Message(m);
            message.destinationName = "/MDS";
            if (topic.length > 0) message.destinationName = message.destinationName + "/" + topic;
            client.send(message);        
        }
    }
    */

        function sendMachineMessage(m) {
        if (client) { 
            //var topic = '/MDS/+'
            var message = new Paho.MQTT.Message(m);
            message.destinationName = "/MDS/Interactive";
            //if (topic.length > 0) message.destinationName = message.destinationName + "/" + topic;
            client.send(message);        
        }
    }

    /*Functions added for GUI */

    function sendInterfaceMessage(m1, m2){

        document.getElementById("status").innerHTML =  "<span style=\"color:#355ea3\">" + m1 + "</span>" + '&nbsp &nbsp &nbsp &nbsp'+ "<span style=\"color:black\">" + m2 + "</span>"; ; 

    }

    function toggleMenuElement(menuToToggle){

            var menu = document.getElementById(menuToToggle);
            
            if (menu.style.display === "none"){
                //console.log("visible " + menuToToggle);
                menu.style.display = "block";
            } else {
                menu.style.display = "none";
                //console.log("hiding " + menuToToggle);
            }
        }


    


  
</script>   


    </head>

       <body >
        
        <div id="pageheader">
            <img src="images/biorealize_node_icon.SVG" alt="Node" class="center"> 
        </div>


        <hr class="style_two">

        <div id="messages"></div>

        <div class="section group">
            <div class="col span_1_of_2">


                    <svg id="mdsDrawing"></svg> 
                    <div id="machineStatusBox"> Waiting for Node to Connect... </div>

               <!-- <div class="machineDrawing"></div>  --> 
                    
            </div>
            <div class="col span_1_of_2">
                <div class = "networkstreammenu">
                        Network & User Stream

                        <div id="chartContainer">></div>   

                       </div>


            </div>
        </div>

        
        <hr class="style_one">

        <div id="status">Waiting to connect... </div>



        <div class="section group">
                </div>
                <div class="section group">
                    
                    <div class="col span_1_of_2">
                        <div class = "initmenu">
                        Connect to Node
                        
                        <hr class="style_one">

                        
                        <div id="serverSettingsDisplayBox">
                                 <form>
                                      Server:
                                      <input type="text" id="server" size="16" value="m14.cloudmqtt.com">
                                      Port:
                                      <input type="text" id="port" size="4" value="31969" > 
                                      User:
                                      <input type="text" id="username" size="8" value="witzcpry">
                                      Pass:
                                      <input type="password" id="password" size="6" value="V8cPnM_IEhBS" >

                                      
                                    </form> 
                        </div>

                        <button type="button" id="connectPlatfomButton"  onclick='connectToNodeButtonFunction();'> Connect </button>

                        <hr class="style_one">
                        
                        <p> Advanced Settings</p>

                        <button type="button" onclick='specSettingsButtonFunction();'>Spec</button>
                        <button type="button" onclick='climateSettingsButtonFunction();'>Heater/Cooler</button>
                        <button type="button" onclick='motorSettingsButtonFunction();'>Motor Control</button>

                         <!--<<button type="button" id="initPlatfomButton"  onclick='initPlatformButtonFunction();'> Initialize </button>-->

                         <!--<input type="checkbox" checked id="driveMachineCheckbox"  onclick='handleDriveMachineCheckboxClick(this);'-->

                        <hr class="style_one">


                        <div id="specSettingsMenu">
                         <p> Spec Configuration</p>

                        
                        <button type="button" onclick='specStartFunction();'>Start Spec</button>
                        <button type="button" onclick='specShowFunction();'>Show Spec</button>
                        <!--<button type="button" onclick='specStopFunction();'>Stop</button>-->
                        <button type="button" onclick='specRawSpectrumFunction();'>Raw Spectrum</button>

                        <hr class="style_one">

                        <p> Sampling Duration</p>
                        <select id="specSamplingDurationMenu">
                        <option value="01:00"> 1 min </option>
                        <option value="10:00"> 10 mins </option>
                        <option value="30:00"> 30 mins </option
                        <option value="60:00"> 60 mins </option>
                        </select>

                        <p> Optional Features </p>
                        <button type="button" onclick='specLightOnFunction();'>Light On</button>
                        <button type="button" onclick='specLightOffFunction();'>Light Off</button>
                        <!--<button type="button" onclick='specUVOnFunction();'>UV On</button>-->
                        <!--<button type="button" onclick='specUVOffFunction();'>UV Off</button>-->

                        <hr class="style_one">
                        
                        <p> Spectrometer Calibration </p>

                        
                        SN: <input type="text" size="3" id="serialNum" >
                        A0: <input type="text" size="3" id="A0">
                        B1: <input type="text" size="3" id="B1">
                        B2: <input type="text" size="3" id="B2">>
                        B3: <input type="text" size="3" id="B3">
                        B4: <input type="text" size="3" id="B4">
                        B5: <input type="text" size="3" id="B5">

                        &nbsp  <button type="button" id="setSpecCalibration" onclick= "setSpecCalibrationButtonFunction();" > Set </button>  
                       
                        </div>    


                        <div id="climateSettingsMenu">

                        <p> Heater Settings </p>
                        <button type="button" onclick='heaterButtonFunction(1);'>Start Heater</button>
                        <button type="button" onclick='heaterButtonFunction(0);'>Stop Heater</button>
                        <button type="button" onclick='coolerButtonFunction(1);'>Start Cooler</button>
                        <button type="button" onclick='coolerButtonFunction(0);'>Stop Cooler</button>
                        <button type="button" onclick='getTempButtonFunction();'>Get Temperature</button>

                        </div>


                        <div id="motorSettingsMenu">

                        <p> Motor Settings </p>
                        <!--<button type="button" onclick='spinMotorButtonFunction(1);'>Spin Motor(->)</button>-->
                        <!--<button type="button" onclick='spinMotorButtonFunction(0);'>Spin Motor(<-)</button>-->
                        <button type="button" onclick='contSpinMotorButtonFunction();'>Spin Motor(<->)</button>
                        <button type="button" id="pauseMotorButton" onclick='pauseMotorButtonFunction();'>Pause </button>
                        <!--<<input onclick="pauseMotorButtonFunction()" type="button" value="Pause" id="pauseMotorButton" />-->

                        </div>


                        </div>
                    </div> 


                    <div class="col span_1_of_2">
                    
                        <div class = "experimentmenu">

                            <div id="experimentReadyElements">
                            Node Ready for Experiment   
                                <hr class="style_one">

                                <button type="button" id="setSpecCalibration" onclick= "scanYourExperimentButtonFunction();" > Scan Your Experiment </button>  
                                <!--<a href="#" class="button1" onclick='scanYourExperimentButtonFunction();' >Scan Your Experiment</a>-->
                                
                            </div>
                       </div> 
                   </div>
                    <!-- 
                    <div class="col span_1_of_2">

                        <div class = "experimentinprogressmenu">
                        2.Experimeny in Progress


                         <hr class="style_one">
                        <p> Spectrometer Calibration </p>

                        
                    
                        
                         <hr class="style_one">



                       </div> 

                       
                    </div>
                    -->  
                    <!-- 
                    <div class="col span_1_of_2">
                        <div class = "experimentfinishedmenu">
                        2. Experiment Finished
                        <br>
                        
                        <hr class="style_one">

                        <p> Spectrometer Calibration </p>

                        
                        
                         <hr class="style_one">

                        </div>
                        
                    </div>--> 

                </div>

                 <hr class="style_one">
                        <!-- Responsive and mobile friendly 
                        <p> Debug Command &nbsp &nbsp &nbsp  &nbsp &nbsp   &nbsp&nbsp  &nbsp  &nbsp  &nbsp&nbsp  &nbsp  &nbsp  &nbsp  Simulation Control </p>

                        <input type="text" id="rawCommandForDebug" value="@___:___;" size="20"> 
                        <button type="button" onclick='sendRawCommandFunction();'> -></button>
                        

                        <button type="button" onclick='sendMachineMessage("@electroporator:SIMULATION_ON;");'>Simulation On</button>
                        <button type="button" onclick='sendMachineMessage("@electroporator:SIMULATION_OFF;");'>Simluation Off</button>  

                <hr class="style_one"> 
                --> 
                <div id="pagefooter">Biorealize Inc. 2018 | NODE | CC-BY-SA 4.0 </div>
                        <!-- The analytics chart is loaded here from CanvasJS --> 


    </body>
</html>
